{"version":3,"sources":["../src/dropdown.js"],"names":["DEFAULT_CLASS_NAME","Dropdown","el","document","createElement","style","display","position","zIndex","body","appendChild","options","shown","items","activeItem","footer","header","maxCount","className","rotate","hasOwnProperty","placement","itemOptions","item","Object","keys","forEach","key","parentNode","removeChild","clear","_el","searchResults","cursorOffset","renderEvent","cancelable","emit","defaultPrevented","rawResults","map","searchResult","data","dropdownItems","slice","length","setStrategyId","renderEdge","append","show","setOffset","hide","dropdownItem","detail","selectEvent","deactivate","e","moveActiveItem","fragment","createDocumentFragment","push","appended","doc","documentElement","elementWidth","offsetWidth","left","browserWidth","clientWidth","right","isPlacementTop","bottom","clientHeight","top","lineHeight","showEvent","hideEvent","innerHTML","destroy","direction","nextActiveItem","next","prev","activate","preventDefault","strategyId","strategy","props","id","setAttribute","removeAttribute","type","source","content","li","classList","add"],"mappings":";;;;;;;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;;;;;;;AAGA,IAAMA,qBAAqB,qCAA3B;;AAEA;;AAYA;;;;;;IAMqBC,Q;;;;;oCAYsB;AACvC,UAAMC,KAAKC,SAASC,aAAT,CAAuB,IAAvB,CAAX;AACA,UAAMC,QAAQH,GAAGG,KAAjB;AACAA,YAAMC,OAAN,GAAgB,MAAhB;AACAD,YAAME,QAAN,GAAiB,UAAjB;AACAF,YAAMG,MAAN,GAAe,OAAf;AACA,UAAMC,OAAON,SAASM,IAAtB;AACA,UAAIA,IAAJ,EAAU;AACRA,aAAKC,WAAL,CAAiBR,EAAjB;AACD;AACD,aAAOA,EAAP;AACD;;;AAED,oBAAYS,OAAZ,EAAsC;AAAA;;AAAA;;AAEpC,UAAKC,KAAL,GAAa,KAAb;AACA,UAAKC,KAAL,GAAa,EAAb;AACA,UAAKC,UAAL,GAAkB,IAAlB;AACA,UAAKC,MAAL,GAAcJ,QAAQI,MAAtB;AACA,UAAKC,MAAL,GAAcL,QAAQK,MAAtB;AACA,UAAKC,QAAL,GAAgBN,QAAQM,QAAR,IAAoB,EAApC;AACA,UAAKf,EAAL,CAAQgB,SAAR,GAAoBP,QAAQO,SAAR,IAAqBlB,kBAAzC;AACA,UAAKmB,MAAL,GAAcR,QAAQS,cAAR,CAAuB,QAAvB,IAAmCT,QAAQQ,MAA3C,GAAoD,IAAlE;AACA,UAAKE,SAAL,GAAiBV,QAAQU,SAAzB;AACA,UAAKC,WAAL,GAAmBX,QAAQY,IAAR,IAAgB,EAAnC;AACA,QAAMlB,QAAQM,QAAQN,KAAtB;AACA,QAAIA,KAAJ,EAAW;AACTmB,aAAOC,IAAP,CAAYpB,KAAZ,EAAmBqB,OAAnB,CAA2B,eAAO;AAChC,SAAE,MAAKxB,EAAL,CAAQG,KAAT,CAAqBsB,GAArB,IAA4BtB,MAAMsB,GAAN,CAA5B;AACF,OAFD;AAGD;AAjBmC;AAkBrC;;AAED;;;;;;;8BAGU;AACR,UAAMC,aAAa,KAAK1B,EAAL,CAAQ0B,UAA3B;AACA,UAAIA,UAAJ,EAAgB;AACdA,mBAAWC,WAAX,CAAuB,KAAK3B,EAA5B;AACD;AACD,WAAK4B,KAAL,GAAaC,GAAb,GAAmB,IAAnB;AACA,aAAO,IAAP;AACD;;;;;AASD;;;;;2BAKOC,a,EAA+BC,Y,EAA4B;AAAA;;AAChE,UAAMC,cAAc,8BAAkB,QAAlB,EAA4B,EAAEC,YAAY,IAAd,EAA5B,CAApB;AACA,WAAKC,IAAL,CAAU,QAAV,EAAoBF,WAApB;AACA,UAAIA,YAAYG,gBAAhB,EAAkC;AAChC,eAAO,IAAP;AACD;AACD,UAAMC,aAAaN,cAAcO,GAAd,CAAkB;AAAA,eAAgBC,aAAaC,IAA7B;AAAA,OAAlB,CAAnB;AACA,UAAMC,gBAAgBV,cACnBW,KADmB,CACb,CADa,EACV,KAAK1B,QAAL,IAAiBe,cAAcY,MADrB,EAEnBL,GAFmB,CAEf;AAAA,eAAgB,4BAAiBC,YAAjB,EAA+B,OAAKlB,WAApC,CAAhB;AAAA,OAFe,CAAtB;AAGA,WAAKQ,KAAL,GACGe,aADH,CACiBb,cAAc,CAAd,CADjB,EAEGc,UAFH,CAEcR,UAFd,EAE0B,QAF1B,EAGGS,MAHH,CAGUL,aAHV,EAIGI,UAJH,CAIcR,UAJd,EAI0B,QAJ1B,EAKGU,IALH,GAMGC,SANH,CAMahB,YANb;AAOA,WAAKG,IAAL,CAAU,UAAV,EAAsB,8BAAkB,UAAlB,CAAtB;AACA,aAAO,IAAP;AACD;;AAED;;;;;;;;iCAKa;AACX,aAAO,KAAKc,IAAL,GAAYpB,KAAZ,EAAP;AACD;;AAED;;;;;;2BAGOqB,Y,EAA4B;AACjC,UAAMC,SAAS,EAAEZ,cAAcW,aAAaX,YAA7B,EAAf;AACA,UAAMa,cAAc,8BAAkB,QAAlB,EAA4B;AAC9ClB,oBAAY,IADkC;AAE9CiB,gBAAQA;AAFsC,OAA5B,CAApB;AAIA,WAAKhB,IAAL,CAAU,QAAV,EAAoBiB,WAApB;AACA,UAAIA,YAAYhB,gBAAhB,EAAkC;AAChC,eAAO,IAAP;AACD;AACD,WAAKiB,UAAL;AACA,WAAKlB,IAAL,CAAU,UAAV,EAAsB,8BAAkB,UAAlB,EAA8B,EAAEgB,cAAF,EAA9B,CAAtB;AACA,aAAO,IAAP;AACD;;AAED;;;;;;uBAGGG,C,EAAgB;AACjB,aAAO,KAAK3C,KAAL,GAAa,KAAK4C,cAAL,CAAoB,MAApB,EAA4BD,CAA5B,CAAb,GAA8C,IAArD;AACD;;AAED;;;;;;yBAGKA,C,EAAgB;AACnB,aAAO,KAAK3C,KAAL,GAAa,KAAK4C,cAAL,CAAoB,MAApB,EAA4BD,CAA5B,CAAb,GAA8C,IAArD;AACD;;AAED;;;;;;oCAGqC;AACnC,aAAO,KAAKzC,UAAZ;AACD;;AAED;;;;;;;;2BAKOD,K,EAAuB;AAAA;;AAC5B,UAAM4C,WAAWtD,SAASuD,sBAAT,EAAjB;AACA7C,YAAMa,OAAN,CAAc,gBAAQ;AACpB,eAAKb,KAAL,CAAW8C,IAAX,CAAgBpC,IAAhB;AACAA,aAAKqC,QAAL;AACAH,iBAAS/C,WAAT,CAAqBa,KAAKrB,EAA1B;AACD,OAJD;AAKA,WAAKA,EAAL,CAAQQ,WAAR,CAAoB+C,QAApB;AACA,aAAO,IAAP;AACD;;AAED;;;;8BACUxB,Y,EAA4B;AACpC,UAAM4B,MAAM1D,SAAS2D,eAArB;AACA,UAAID,GAAJ,EAAS;AACP,YAAME,eAAe,KAAK7D,EAAL,CAAQ8D,WAA7B;AACA,YAAI/B,aAAagC,IAAjB,EAAuB;AACrB,cAAMC,eAAeL,IAAIM,WAAzB;AACA,cAAIlC,aAAagC,IAAb,GAAoBF,YAApB,GAAmCG,YAAvC,EAAqD;AACnDjC,yBAAagC,IAAb,GAAoBC,eAAeH,YAAnC;AACD;AACD,eAAK7D,EAAL,CAAQG,KAAR,CAAc4D,IAAd,GAAwBhC,aAAagC,IAArC;AACD,SAND,MAMO,IAAIhC,aAAamC,KAAjB,EAAwB;AAC7B,cAAInC,aAAamC,KAAb,GAAqBL,YAArB,GAAoC,CAAxC,EAA2C;AACzC9B,yBAAamC,KAAb,GAAqB,CAArB;AACD;AACD,eAAKlE,EAAL,CAAQG,KAAR,CAAc+D,KAAd,GAAyBnC,aAAamC,KAAtC;AACD;AACD,YAAI,KAAKC,cAAL,EAAJ,EAA2B;AACzB,eAAKnE,EAAL,CAAQG,KAAR,CAAciE,MAAd,GAA0BT,IAAIU,YAAJ,GACxBtC,aAAauC,GADW,GAExBvC,aAAawC,UAFf;AAGD,SAJD,MAIO;AACL,eAAKvE,EAAL,CAAQG,KAAR,CAAcmE,GAAd,GAAuBvC,aAAauC,GAApC;AACD;AACF;AACD,aAAO,IAAP;AACD;;AAED;;;;;;;;2BAKO;AACL,UAAI,CAAC,KAAK5D,KAAV,EAAiB;AACf,YAAM8D,YAAY,8BAAkB,MAAlB,EAA0B,EAAEvC,YAAY,IAAd,EAA1B,CAAlB;AACA,aAAKC,IAAL,CAAU,MAAV,EAAkBsC,SAAlB;AACA,YAAIA,UAAUrC,gBAAd,EAAgC;AAC9B,iBAAO,IAAP;AACD;AACD,aAAKnC,EAAL,CAAQG,KAAR,CAAcC,OAAd,GAAwB,OAAxB;AACA,aAAKM,KAAL,GAAa,IAAb;AACA,aAAKwB,IAAL,CAAU,OAAV,EAAmB,8BAAkB,OAAlB,CAAnB;AACD;AACD,aAAO,IAAP;AACD;;AAED;;;;;;;;2BAKO;AACL,UAAI,KAAKxB,KAAT,EAAgB;AACd,YAAM+D,YAAY,8BAAkB,MAAlB,EAA0B,EAAExC,YAAY,IAAd,EAA1B,CAAlB;AACA,aAAKC,IAAL,CAAU,MAAV,EAAkBuC,SAAlB;AACA,YAAIA,UAAUtC,gBAAd,EAAgC;AAC9B,iBAAO,IAAP;AACD;AACD,aAAKnC,EAAL,CAAQG,KAAR,CAAcC,OAAd,GAAwB,MAAxB;AACA,aAAKM,KAAL,GAAa,KAAb;AACA,aAAKwB,IAAL,CAAU,QAAV,EAAoB,8BAAkB,QAAlB,CAApB;AACD;AACD,aAAO,IAAP;AACD;;AAED;;;;;;;;4BAKQ;AACN,WAAKlC,EAAL,CAAQ0E,SAAR,GAAoB,EAApB;AACA,WAAK/D,KAAL,CAAWa,OAAX,CAAmB;AAAA,eAAQH,KAAKsD,OAAL,EAAR;AAAA,OAAnB;AACA,WAAKhE,KAAL,GAAa,EAAb;AACA,aAAO,IAAP;AACD;;AAED;;;;mCACeiE,S,EAA4BvB,C,EAAgB;AACzD,UAAMwB,iBACJD,cAAc,MAAd,GACI,KAAKhE,UAAL,GAAkB,KAAKA,UAAL,CAAgBkE,IAAlC,GAAyC,KAAKnE,KAAL,CAAW,CAAX,CAD7C,GAEI,KAAKC,UAAL,GACE,KAAKA,UAAL,CAAgBmE,IADlB,GAEE,KAAKpE,KAAL,CAAW,KAAKA,KAAL,CAAW+B,MAAX,GAAoB,CAA/B,CALR;AAMA,UAAImC,cAAJ,EAAoB;AAClBA,uBAAeG,QAAf;AACA3B,UAAE4B,cAAF;AACD;AACD,aAAO,IAAP;AACD;;AAED;;;;kCACc3C,Y,EAA6B;AACzC,UAAM4C,aAAa5C,gBAAgBA,aAAa6C,QAAb,CAAsBC,KAAtB,CAA4BC,EAA/D;AACA,UAAIH,UAAJ,EAAgB;AACd,aAAKlF,EAAL,CAAQsF,YAAR,CAAqB,eAArB,EAAsCJ,UAAtC;AACD,OAFD,MAEO;AACL,aAAKlF,EAAL,CAAQuF,eAAR,CAAwB,eAAxB;AACD;AACD,aAAO,IAAP;AACD;;AAED;;;;;;;+BAIWnD,U,EAAsBoD,I,EAA2B;AAC1D,UAAMC,SAAS,CAACD,SAAS,QAAT,GAAoB,KAAK1E,MAAzB,GAAkC,KAAKD,MAAxC,KAAmD,EAAlE;AACA,UAAM6E,UACJ,OAAOD,MAAP,KAAkB,UAAlB,GAA+BA,OAAOrD,UAAP,CAA/B,GAAoDqD,MADtD;AAEA,UAAME,KAAK1F,SAASC,aAAT,CAAuB,IAAvB,CAAX;AACAyF,SAAGC,SAAH,CAAaC,GAAb,mBAAiCL,IAAjC;AACAG,SAAGjB,SAAH,GAAegB,OAAf;AACA,WAAK1F,EAAL,CAAQQ,WAAR,CAAoBmF,EAApB;AACA,aAAO,IAAP;AACD;;AAED;;;;qCACiB;AACf,aAAO,KAAKxE,SAAL,KAAmB,KAA1B;AACD;;;wBA3N0B;AACzB,UAAI,CAAC,KAAKU,GAAV,EAAe;AACb,aAAKA,GAAL,GAAW9B,SAASG,aAAT,EAAX;AACD;AACD,aAAO,KAAK2B,GAAZ;AACD;;;;;;kBA9DkB9B,Q","file":"dropdown.js","sourcesContent":["// @flow\nimport EventEmitter from \"eventemitter3\"\n\nimport DropdownItem, { type DropdownItemOptions } from \"./dropdown_item\"\nimport SearchResult from \"./search_result\"\nimport { createCustomEvent } from \"./utils\"\nimport type { CursorOffset } from \"./editor\"\n\nconst DEFAULT_CLASS_NAME = \"dropdown-menu textcomplete-dropdown\"\n\n/** @typedef */\nexport type DropdownOptions = {\n  className?: string,\n  footer?: any => string | string,\n  header?: any => string | string,\n  maxCount?: number,\n  placement?: string,\n  rotate?: boolean,\n  style?: { [string]: string },\n  item?: DropdownItemOptions,\n}\n\n/**\n * Encapsulate a dropdown view.\n *\n * @prop {boolean} shown - Whether the #el is shown or not.\n * @prop {DropdownItem[]} items - The array of rendered dropdown items.\n */\nexport default class Dropdown extends EventEmitter {\n  shown: boolean\n  items: DropdownItem[]\n  activeItem: DropdownItem | null\n  footer: $PropertyType<DropdownOptions, \"footer\">\n  header: $PropertyType<DropdownOptions, \"header\">\n  maxCount: $PropertyType<DropdownOptions, \"maxCount\">\n  rotate: $PropertyType<DropdownOptions, \"rotate\">\n  placement: $PropertyType<DropdownOptions, \"placement\">\n  itemOptions: DropdownItemOptions\n  _el: ?HTMLUListElement\n\n  static createElement(): HTMLUListElement {\n    const el = document.createElement(\"ul\")\n    const style = el.style\n    style.display = \"none\"\n    style.position = \"absolute\"\n    style.zIndex = \"10000\"\n    const body = document.body\n    if (body) {\n      body.appendChild(el)\n    }\n    return el\n  }\n\n  constructor(options: DropdownOptions) {\n    super()\n    this.shown = false\n    this.items = []\n    this.activeItem = null\n    this.footer = options.footer\n    this.header = options.header\n    this.maxCount = options.maxCount || 10\n    this.el.className = options.className || DEFAULT_CLASS_NAME\n    this.rotate = options.hasOwnProperty(\"rotate\") ? options.rotate : true\n    this.placement = options.placement\n    this.itemOptions = options.item || {}\n    const style = options.style\n    if (style) {\n      Object.keys(style).forEach(key => {\n        ;(this.el.style: any)[key] = style[key]\n      })\n    }\n  }\n\n  /**\n   * @return {this}\n   */\n  destroy() {\n    const parentNode = this.el.parentNode\n    if (parentNode) {\n      parentNode.removeChild(this.el)\n    }\n    this.clear()._el = null\n    return this\n  }\n\n  get el(): HTMLUListElement {\n    if (!this._el) {\n      this._el = Dropdown.createElement()\n    }\n    return this._el\n  }\n\n  /**\n   * Render the given data as dropdown items.\n   *\n   * @return {this}\n   */\n  render(searchResults: SearchResult[], cursorOffset: CursorOffset) {\n    const renderEvent = createCustomEvent(\"render\", { cancelable: true })\n    this.emit(\"render\", renderEvent)\n    if (renderEvent.defaultPrevented) {\n      return this\n    }\n    const rawResults = searchResults.map(searchResult => searchResult.data)\n    const dropdownItems = searchResults\n      .slice(0, this.maxCount || searchResults.length)\n      .map(searchResult => new DropdownItem(searchResult, this.itemOptions))\n    this.clear()\n      .setStrategyId(searchResults[0])\n      .renderEdge(rawResults, \"header\")\n      .append(dropdownItems)\n      .renderEdge(rawResults, \"footer\")\n      .show()\n      .setOffset(cursorOffset)\n    this.emit(\"rendered\", createCustomEvent(\"rendered\"))\n    return this\n  }\n\n  /**\n   * Hide the dropdown then sweep out items.\n   *\n   * @return {this}\n   */\n  deactivate() {\n    return this.hide().clear()\n  }\n\n  /**\n   * @return {this}\n   */\n  select(dropdownItem: DropdownItem) {\n    const detail = { searchResult: dropdownItem.searchResult }\n    const selectEvent = createCustomEvent(\"select\", {\n      cancelable: true,\n      detail: detail,\n    })\n    this.emit(\"select\", selectEvent)\n    if (selectEvent.defaultPrevented) {\n      return this\n    }\n    this.deactivate()\n    this.emit(\"selected\", createCustomEvent(\"selected\", { detail }))\n    return this\n  }\n\n  /**\n   * @return {this}\n   */\n  up(e: CustomEvent) {\n    return this.shown ? this.moveActiveItem(\"prev\", e) : this\n  }\n\n  /**\n   * @return {this}\n   */\n  down(e: CustomEvent) {\n    return this.shown ? this.moveActiveItem(\"next\", e) : this\n  }\n\n  /**\n   * Retrieve the active item.\n   */\n  getActiveItem(): DropdownItem | null {\n    return this.activeItem\n  }\n\n  /**\n   * Add items to dropdown.\n   *\n   * @private\n   */\n  append(items: DropdownItem[]) {\n    const fragment = document.createDocumentFragment()\n    items.forEach(item => {\n      this.items.push(item)\n      item.appended(this)\n      fragment.appendChild(item.el)\n    })\n    this.el.appendChild(fragment)\n    return this\n  }\n\n  /** @private */\n  setOffset(cursorOffset: CursorOffset) {\n    const doc = document.documentElement\n    if (doc) {\n      const elementWidth = this.el.offsetWidth\n      if (cursorOffset.left) {\n        const browserWidth = doc.clientWidth\n        if (cursorOffset.left + elementWidth > browserWidth) {\n          cursorOffset.left = browserWidth - elementWidth\n        }\n        this.el.style.left = `${cursorOffset.left}px`\n      } else if (cursorOffset.right) {\n        if (cursorOffset.right - elementWidth < 0) {\n          cursorOffset.right = 0\n        }\n        this.el.style.right = `${cursorOffset.right}px`\n      }\n      if (this.isPlacementTop()) {\n        this.el.style.bottom = `${doc.clientHeight -\n          cursorOffset.top +\n          cursorOffset.lineHeight}px`\n      } else {\n        this.el.style.top = `${cursorOffset.top}px`\n      }\n    }\n    return this\n  }\n\n  /**\n   * Show the element.\n   *\n   * @private\n   */\n  show() {\n    if (!this.shown) {\n      const showEvent = createCustomEvent(\"show\", { cancelable: true })\n      this.emit(\"show\", showEvent)\n      if (showEvent.defaultPrevented) {\n        return this\n      }\n      this.el.style.display = \"block\"\n      this.shown = true\n      this.emit(\"shown\", createCustomEvent(\"shown\"))\n    }\n    return this\n  }\n\n  /**\n   * Hide the element.\n   *\n   * @private\n   */\n  hide() {\n    if (this.shown) {\n      const hideEvent = createCustomEvent(\"hide\", { cancelable: true })\n      this.emit(\"hide\", hideEvent)\n      if (hideEvent.defaultPrevented) {\n        return this\n      }\n      this.el.style.display = \"none\"\n      this.shown = false\n      this.emit(\"hidden\", createCustomEvent(\"hidden\"))\n    }\n    return this\n  }\n\n  /**\n   * Clear search results.\n   *\n   * @private\n   */\n  clear() {\n    this.el.innerHTML = \"\"\n    this.items.forEach(item => item.destroy())\n    this.items = []\n    return this\n  }\n\n  /** @private */\n  moveActiveItem(direction: \"next\" | \"prev\", e: CustomEvent) {\n    const nextActiveItem =\n      direction === \"next\"\n        ? this.activeItem ? this.activeItem.next : this.items[0]\n        : this.activeItem\n          ? this.activeItem.prev\n          : this.items[this.items.length - 1]\n    if (nextActiveItem) {\n      nextActiveItem.activate()\n      e.preventDefault()\n    }\n    return this\n  }\n\n  /** @private */\n  setStrategyId(searchResult: ?SearchResult) {\n    const strategyId = searchResult && searchResult.strategy.props.id\n    if (strategyId) {\n      this.el.setAttribute(\"data-strategy\", strategyId)\n    } else {\n      this.el.removeAttribute(\"data-strategy\")\n    }\n    return this\n  }\n\n  /**\n   * @private\n   * @param {object[]} rawResults - What callbacked by search function.\n   */\n  renderEdge(rawResults: Object[], type: \"header\" | \"footer\") {\n    const source = (type === \"header\" ? this.header : this.footer) || \"\"\n    const content: any =\n      typeof source === \"function\" ? source(rawResults) : source\n    const li = document.createElement(\"li\")\n    li.classList.add(`textcomplete-${type}`)\n    li.innerHTML = content\n    this.el.appendChild(li)\n    return this\n  }\n\n  /** @private */\n  isPlacementTop() {\n    return this.placement === \"top\"\n  }\n}\n"]}